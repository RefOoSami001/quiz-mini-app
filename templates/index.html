<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RefOo Quiz Maker</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Cairo:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --font-english: 'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            --font-arabic: 'Cairo', 'Segoe UI', Tahoma, Arial, sans-serif;
            --animation-duration: 0.2s;
            --animation-easing: cubic-bezier(0.4, 0, 0.2, 1);
            --bg-main: #eef2fb;
            --bg-soft: #ffffff;
            --shadow-light: rgba(255, 255, 255, 0.85);
            --shadow-dark: rgba(15, 23, 42, 0.18);
            --primary-blue: #6c63ff;
            --accent-cyan: #3bc9db;
        }

        body {
            font-family: var(--font-english);
            background: radial-gradient(circle at 20% 20%, rgba(108,99,255,0.12), transparent 45%),
                        radial-gradient(circle at 80% 0%, rgba(59,201,219,0.12), transparent 40%),
                        var(--bg-main);
            color: #1e293b;
            line-height: 1.6;
            padding: 24px 16px 140px;
            min-height: 100vh;
            margin: 0;
            transition: all var(--animation-duration) var(--animation-easing);
        }

        body[dir="rtl"] {
            font-family: var(--font-arabic);
        }

        .container {
            max-width: 640px;
            margin: 0 auto;
            animation: fadeInUp 0.6s var(--animation-easing);
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .language-selector {
            position: fixed;
            top: 16px;
            right: 16px;
            z-index: 1000;
            background: var(--bg-soft);
            border-radius: 26px;
            padding: 6px;
            box-shadow: 14px 14px 30px var(--shadow-dark), -12px -12px 24px var(--shadow-light);
            display: flex;
            gap: 8px;
            animation: slideInRight 0.5s var(--animation-easing);
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(50px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .lang-btn {
            padding: 8px 18px;
            border: none;
            border-radius: 18px;
            background: transparent;
            color: #475569;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--animation-duration) var(--animation-easing);
            display: flex;
            align-items: center;
            gap: 6px;
            box-shadow: inset 4px 4px 8px rgba(0,0,0,0.05), inset -4px -4px 8px rgba(255,255,255,0.9);
        }

        .lang-btn:hover {
            color: var(--primary-blue);
        }

        .lang-btn.active {
            background: linear-gradient(135deg, var(--primary-blue), var(--accent-cyan));
            color: white;
            box-shadow: 0 12px 25px rgba(102,99,255,0.35);
        }

        .header {
            text-align: center;
            margin-bottom: 16px;
            animation: fadeInUp 0.8s var(--animation-easing);
        }

        .header h1 {
            font-size: 30px;
            margin-bottom: 10px;
            color: #0f172a;
            font-weight: 700;
        }

        .header p {
            color: #6b7280;
            font-size: 16px;
        }

        .brand-follow {
            margin: 0 auto 24px;
            max-width: 520px;
            padding: 16px 20px;
            border-radius: 22px;
            background: var(--bg-soft);
            border: 1px solid rgba(255,255,255,0.4);
            box-shadow: 20px 20px 40px var(--shadow-dark), -15px -15px 35px var(--shadow-light);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            flex-wrap: wrap;
        }

        .brand-follow span {
            font-size: 15px;
            font-weight: 600;
            color: #1e293b;
        }

        .brand-follow a {
            background: linear-gradient(135deg, var(--primary-blue), var(--accent-cyan));
            color: white;
            padding: 10px 18px;
            border-radius: 16px;
            text-decoration: none;
            font-weight: 600;
            box-shadow: 0 12px 25px rgba(102,99,255,0.25);
            transition: transform 0.2s ease;
        }

        .brand-follow a:hover {
            transform: translateY(-2px);
        }

        .value-badges {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            justify-content: center;
            margin-bottom: 24px;
        }

        .value-badges .badge {
            padding: 10px 16px;
            border-radius: 16px;
            background: var(--bg-soft);
            color: #475569;
            font-weight: 600;
            font-size: 13px;
            box-shadow: 12px 12px 20px rgba(15,23,42,0.1), -10px -10px 18px rgba(255,255,255,0.8);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .card {
            background: var(--bg-soft);
            border-radius: 28px;
            padding: 28px;
            margin-bottom: 26px;
            border: 1px solid rgba(255,255,255,0.35);
            box-shadow: 28px 28px 50px var(--shadow-dark),
                        -22px -22px 45px var(--shadow-light);
            transition: transform 0.35s var(--animation-easing), box-shadow 0.35s var(--animation-easing);
            animation: slideInUp 0.5s var(--animation-easing);
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .card:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }

        .step {
            display: none;
            opacity: 0;
            transform: translateX(30px);
            transition: all 0.2s var(--animation-easing);
        }

        .step.active {
            display: block;
            opacity: 1;
            transform: translateX(0);
            animation: slideInFromRight 0.3s var(--animation-easing);
        }

        @keyframes slideInFromRight {
            from {
                opacity: 0;
                transform: translateX(30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .step-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--tg-theme-text-color, #000000);
        }

        .step-navigation {
            display: flex;
            gap: 12px;
            margin-top: 20px;
            align-items: center;
        }

        .step-navigation .btn {
            flex: 1;
            min-width: 0;
        }

        .step-navigation .btn-secondary {
            flex: 0 0 auto;
            min-width: 100px;
            max-width: 120px;
        }

        .model-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }

        .model-btn {
            padding: 18px;
            border-radius: 22px;
            border: none;
            background: linear-gradient(145deg, rgba(255,255,255,0.75), rgba(209,213,219,0.4));
            color: #475569;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--animation-duration) var(--animation-easing);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            text-align: center;
            box-shadow: inset 5px 5px 10px rgba(255,255,255,0.85), inset -6px -6px 14px rgba(0,0,0,0.05), 18px 18px 30px rgba(15,23,42,0.1);
        }

        .model-btn i {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .model-btn:hover,
        .model-btn.selected {
            color: #0f172a;
            background: linear-gradient(135deg, var(--primary-blue), var(--accent-cyan));
            transform: translateY(-2px);
            box-shadow: 0 12px 28px rgba(59,201,219,0.25);
        }

        .question-count-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .count-btn {
            padding: 14px;
            border-radius: 22px;
            border: none;
            background: linear-gradient(145deg, rgba(255,255,255,0.75), rgba(209,213,219,0.3));
            color: #475569;
            font-size: 14px;
            cursor: pointer;
            transition: all var(--animation-duration) var(--animation-easing);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            text-align: center;
            box-shadow: inset 4px 4px 8px rgba(255,255,255,0.85),
                        inset -4px -4px 8px rgba(0,0,0,0.04),
                        15px 15px 22px rgba(15,23,42,0.08);
        }

        .count-btn i {
            font-size: 18px;
        }

        .count-btn:hover,
        .count-btn.selected {
            color: #0f172a;
            background: linear-gradient(135deg, var(--primary-blue), var(--accent-cyan));
            box-shadow: 0 12px 24px rgba(102,99,255,0.25);
            transform: translateY(-1px);
        }

        .input-type-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }

        .input-btn {
            padding: 18px;
            border-radius: 24px;
            border: none;
            background: linear-gradient(145deg, rgba(255,255,255,0.8), rgba(209,213,219,0.3));
            color: #475569;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--animation-duration) var(--animation-easing);
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            box-shadow: inset 4px 4px 8px rgba(255,255,255,0.85),
                        inset -4px -4px 8px rgba(0,0,0,0.05),
                        18px 18px 28px rgba(15,23,42,0.08);
        }

        .input-btn i {
            font-size: 24px;
        }

        .input-btn:hover,
        .input-btn.selected {
            color: #0f172a;
            background: linear-gradient(135deg, var(--primary-blue), var(--accent-cyan));
            box-shadow: 0 12px 24px rgba(102,99,255,0.25);
            transform: translateY(-2px);
        }

        .text-input {
            width: 100%;
            min-height: 200px;
            padding: 15px;
            border: 1px solid var(--tg-theme-section-separator-color, #e1e5e9);
            border-radius: 8px;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            font-size: 14px;
            resize: vertical;
            font-family: inherit;
        }

        .file-input-container {
            text-align: center;
            padding: 20px;
            border: 2px dashed var(--tg-theme-section-separator-color, #e1e5e9);
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .file-input {
            display: none;
        }

        .file-input-label {
            display: inline-block;
            padding: 10px 20px;
            background: var(--tg-theme-button-color, #007bff);
            color: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .page-range-input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--tg-theme-section-separator-color, #e1e5e9);
            border-radius: 6px;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            font-size: 14px;
            margin-bottom: 15px;
        }

        .btn {
            width: 100%;
            padding: 16px 24px;
            background: linear-gradient(135deg, var(--tg-theme-button-color, #007bff) 0%, #0056b3 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--animation-duration) var(--animation-easing);
            box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3);
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s var(--animation-easing);
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 8px 25px rgba(0, 123, 255, 0.5);
        }

        .btn:active {
            transform: translateY(-1px) scale(0.98);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: 0 2px 8px rgba(0, 123, 255, 0.2);
        }

        .btn i {
            font-size: 18px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .btn-secondary {
            background: var(--tg-theme-secondary-bg-color, #f8f9fa);
            color: var(--tg-theme-text-color, #000000);
            border: 1px solid var(--tg-theme-section-separator-color, #e1e5e9);
        }

        .btn-secondary:hover {
            background: var(--tg-theme-section-separator-color, #e1e5e9);
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: var(--tg-theme-hint-color, #999999);
        }

        .spinner {
            border: 3px solid var(--tg-theme-section-separator-color, #e1e5e9);
            border-top: 3px solid var(--tg-theme-button-color, #007bff);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #fcc;
        }

        .success {
            background: #efe;
            color: #363;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #cfc;
        }

        .quiz-container {
            display: none;
            padding-bottom: 100px; /* Space for fixed navigation */
        }

        .quiz-container.active {
            display: block;
        }

        .question-card {
            background: var(--tg-theme-secondary-bg-color, #ffffff);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            border: 1px solid var(--tg-theme-section-separator-color, #e1e5e9);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            backdrop-filter: blur(10px);
        }

        .question-number {
            font-size: 14px;
            color: var(--tg-theme-hint-color, #999999);
            margin-bottom: 10px;
        }

        .question-text {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 15px;
            color: var(--tg-theme-text-color, #000000);
        }

        .explanation {
            background: var(--tg-theme-secondary-bg-color, #f8f9fa);
            border-left: 4px solid var(--tg-theme-button-color, #007bff);
            padding: 15px;
            margin-top: 15px;
            border-radius: 8px;
            font-size: 14px;
            color: var(--tg-theme-text-color, #000000);
            display: none;
            animation: fadeInUp 0.3s ease;
        }

        .explanation.show {
            display: block;
        }

        .explanation-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--tg-theme-button-color, #007bff);
        }

        .options {
            list-style: none;
        }

        .option {
            padding: 16px;
            margin-bottom: 12px;
            border: 2px solid var(--tg-theme-section-separator-color, #e1e5e9);
            border-radius: 12px;
            background: var(--tg-theme-bg-color, #ffffff);
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            position: relative;
            overflow: hidden;
        }

        .option::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(0, 123, 255, 0.1), transparent);
            transition: left 0.5s;
        }

        .option:hover::before {
            left: 100%;
        }

        .option:hover {
            background: var(--tg-theme-secondary-bg-color, #f8f9fa);
        }

        .option.selected {
            background: var(--tg-theme-button-color, #007bff);
            color: white;
            border-color: var(--tg-theme-button-color, #007bff);
        }

        .option.correct {
            background: #4caf50;
            color: white;
            border-color: #4caf50;
            animation: correctPulse 0.3s ease-in-out;
        }

        .option.incorrect {
            background: #f44336;
            color: white;
            border-color: #f44336;
            animation: incorrectShake 0.3s ease-in-out;
        }

        @keyframes correctPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.03); }
            100% { transform: scale(1); }
        }

        @keyframes incorrectShake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-3px); }
            75% { transform: translateX(3px); }
        }

        .quiz-navigation {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--tg-theme-secondary-bg-color, #ffffff);
            border-top: 1px solid var(--tg-theme-section-separator-color, #e1e5e9);
            padding: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.1);
            z-index: 100;
        }

        .quiz-actions {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }

        .telegram-poll-btn {
            background: linear-gradient(135deg, #0088cc 0%, #006699 100%);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 12px 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 136, 204, 0.3);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .telegram-poll-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 136, 204, 0.4);
        }

        .telegram-poll-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .quiz-progress {
            font-size: 14px;
            color: var(--tg-theme-hint-color, #999999);
        }

        .quiz-buttons {
            display: flex;
            gap: 10px;
        }

        .quiz-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .quiz-btn-primary {
            background: var(--tg-theme-button-color, #007bff);
            color: white;
        }

        .quiz-btn-secondary {
            background: var(--tg-theme-secondary-bg-color, #f8f9fa);
            color: var(--tg-theme-text-color, #000000);
            border: 1px solid var(--tg-theme-section-separator-color, #e1e5e9);
        }

        .results-container {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .results-container.active {
            display: block;
        }

        .score {
            font-size: 48px;
            font-weight: bold;
            color: var(--tg-theme-button-color, #007bff);
            margin-bottom: 10px;
        }

        .score-text {
            font-size: 18px;
            color: var(--tg-theme-text-color, #000000);
            margin-bottom: 20px;
        }

        .hidden {
            display: none !important;
        }

        /* RTL Support */
        body[dir="rtl"] .language-selector {
            right: auto;
            left: 16px;
        }

        body[dir="rtl"] .header h1 {
            flex-direction: row-reverse;
        }

        body[dir="rtl"] .btn {
            flex-direction: row-reverse;
        }

        body[dir="rtl"] .quiz-navigation {
            flex-direction: row-reverse;
        }

        body[dir="rtl"] .quiz-buttons {
            flex-direction: row-reverse;
        }

        body[dir="rtl"] .telegram-poll-btn {
            flex-direction: row-reverse;
        }

        /* Loading Animation */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: all var(--animation-duration) var(--animation-easing);
        }

        .loading-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .loading-content {
            background: var(--tg-theme-secondary-bg-color, #ffffff);
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            animation: bounceIn 0.5s var(--animation-easing);
            max-width: 400px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        @keyframes bounceIn {
            0% {
                opacity: 0;
                transform: scale(0.3);
            }
            50% {
                opacity: 1;
                transform: scale(1.05);
            }
            70% {
                transform: scale(0.9);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            margin: 0 auto 20px;
            position: relative;
        }

        .loading-spinner::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 4px solid var(--tg-theme-section-separator-color, #e1e5e9);
            border-top: 4px solid var(--tg-theme-button-color, #007bff);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .loading-spinner::after {
            content: '';
            position: absolute;
            top: 8px;
            left: 8px;
            width: calc(100% - 16px);
            height: calc(100% - 16px);
            border: 3px solid transparent;
            border-top: 3px solid var(--tg-theme-button-color, #007bff);
            border-radius: 50%;
            animation: spin 0.8s linear infinite reverse;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 16px;
            color: var(--tg-theme-text-color, #000000);
            margin-bottom: 10px;
            min-height: 24px;
            animation: fadeInOut 2s ease-in-out infinite;
        }

        .loading-subtitle {
            font-size: 14px;
            color: var(--tg-theme-hint-color, #999999);
            margin-top: 10px;
        }

        @keyframes fadeInOut {
            0%, 100% { opacity: 0.7; }
            50% { opacity: 1; }
        }

        /* Footer */
        .footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--tg-theme-secondary-bg-color, #ffffff);
            border-top: 1px solid var(--tg-theme-section-separator-color, #e1e5e9);
            padding: 12px 16px;
            text-align: center;
            font-size: 14px;
            color: var(--tg-theme-hint-color, #999999);
            z-index: 50;
            display: none;
        }

        .footer.show {
            display: block;
        }

        .footer a {
            color: var(--tg-theme-button-color, #007bff);
            text-decoration: none;
            font-weight: 600;
            transition: all var(--animation-duration) var(--animation-easing);
        }

        .footer a:hover {
            color: #0056b3;
            text-decoration: underline;
        }

        /* Adjust quiz navigation when footer is shown */
        .quiz-navigation.with-footer {
            bottom: 50px;
        }

        @media (max-width: 480px) {
            .model-options,
            .input-type-options {
                grid-template-columns: 1fr;
            }

            .question-count-grid {
                grid-template-columns: repeat(3, 1fr);
            }

            .language-selector {
                top: 8px;
                right: 8px;
                left: auto;
            }

            body[dir="rtl"] .language-selector {
                left: 8px;
                right: auto;
            }

            .quiz-navigation {
                padding: 12px;
            }

            .quiz-container {
                padding-bottom: 80px; /* Smaller space on mobile */
            }
        }
    </style>
</head>
<body>
    <!-- Language Selector -->
                <div class="language-selector">
        <button class="lang-btn" data-lang="en">
                        <i class="fas fa-globe"></i>
            English
                    </button>
        <button class="lang-btn active" data-lang="ar">
            <i class="fas fa-globe"></i>
            Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©
        </button>
                        </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-text" id="loadingText">Processing your request...</div>
            <div class="loading-subtitle" id="loadingSubtitle">This may take a few moments</div>
            </div>
        </div>

    <div class="container">
        <div class="header">
            <br><br><br>
            <p data-en="Transform your study materials into interactive quizzes" data-ar="Ø­ÙˆÙ„ Ù…ÙˆØ§Ø¯Ùƒ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ© Ø¥Ù„Ù‰ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª ØªÙØ§Ø¹Ù„ÙŠØ©">Transform your study materials into interactive quizzes</p>
        </div>

        <div class="brand-follow">
            <span data-en="Support our creative studio RIVAL by following @rival_eg" data-ar="Ø§Ø¯Ø¹Ù… Ø§Ø³ØªÙˆØ¯ÙŠÙˆ Ø±ÙŠÙØ§Ù„ Ø¨Ù…ØªØ§Ø¨Ø¹ØªÙ†Ø§ Ø¹Ù„Ù‰ Ø¥Ù†Ø³ØªØºØ±Ø§Ù… @rival_eg">
                Support our creative studio RIVAL by following @rival_eg
            </span>
            <a href="https://instagram.com/rival_eg" target="_blank" rel="noopener noreferrer" data-en="Follow RIVAL" data-ar="ØªØ§Ø¨Ø¹ RIVAL">
                Follow RIVAL
            </a>
        </div>

        <div class="value-badges">
            <div class="badge" data-en="ðŸ§  AI-powered insights" data-ar="ðŸ§  Ø±Ø¤Ù‰ Ù…Ø¯Ø¹ÙˆÙ…Ø© Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ">ðŸ§  AI-powered insights</div>
            <div class="badge" data-en="âš¡ Lightning fast PDF parsing" data-ar="âš¡ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø³Ø±ÙŠØ¹Ø© Ø¬Ø¯Ø§Ù‹ Ù„Ù„Ù€ PDF">âš¡ Lightning fast PDF parsing</div>
            <div class="badge" data-en="ðŸ“² Ready for Telegram mini apps" data-ar="ðŸ“² Ø¬Ø§Ù‡Ø² Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª ØªÙ„ÙŠØ¬Ø±Ø§Ù… Ø§Ù„Ù…ØµØºØ±Ø©">ðŸ“² Ready for Telegram mini apps</div>
        </div>

        <!-- Step 1: Input Method (inline text or PDF) -->
        <div class="card step active" id="step1">
            <div class="step-title" data-en="How would you like to share your materials?" data-ar="ÙƒÙŠÙ ØªØ±ÙŠØ¯ Ù…Ø´Ø§Ø±ÙƒØ© Ù…ÙˆØ§Ø¯ÙƒØŸ">How would you like to share your materials?</div>
            <div class="input-type-options">
                <button class="input-btn" data-type="text">
                    <i class="fas fa-file-text"></i>
                    <span data-en="Text Message" data-ar="Ø±Ø³Ø§Ù„Ø© Ù†ØµÙŠØ©">Text Message</span>
                </button>
                <button class="input-btn" data-type="pdf">
                    <i class="fas fa-file-pdf"></i>
                    <span data-en="PDF Document" data-ar="Ù…Ø³ØªÙ†Ø¯ PDF">PDF Document</span>
                </button>
                </div>
            <!-- Inline text area -->
            <div id="inlineTextArea" style="display:none; margin-top:12px;">
                <textarea class="text-input" id="textInput"
                    data-placeholder-en="Paste or type your study material here. The more detailed your text, the better the questions!"
                    data-placeholder-ar="Ø§Ù„ØµÙ‚ Ø£Ùˆ Ø§ÙƒØªØ¨ Ù…Ø§Ø¯ØªÙƒ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ© Ù‡Ù†Ø§. ÙƒÙ„Ù…Ø§ ÙƒØ§Ù† Ø§Ù„Ù†Øµ Ø£ÙƒØ«Ø± ØªÙØµÙŠÙ„Ø§Ù‹ØŒ ÙƒØ§Ù†Øª Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø£ÙØ¶Ù„!"
                    placeholder="Paste or type your study material here. The more detailed your text, the better the questions!"></textarea>
            </div>
            <!-- Inline PDF picker -->
            <div id="inlinePdfArea" style="display:none; margin-top:12px;">
                <div class="file-input-container">
                    <input type="file" class="file-input" id="pdfInput" accept=".pdf">
                    <label for="pdfInput" class="file-input-label">
                        <i class="fas fa-upload"></i>
                        <span data-en="Choose PDF File" data-ar="Ø§Ø®ØªØ± Ù…Ù„Ù PDF">Choose PDF File</span>
                    </label>
                    <div id="fileName" style="margin-top: 10px; color: var(--tg-theme-hint-color, #999999);"></div>
                    </div>
                <input type="text" class="page-range-input" id="pageRange"
                    data-placeholder-en="Page range (e.g., 1-5 or 3)"
                    data-placeholder-ar="Ù†Ø·Ø§Ù‚ Ø§Ù„ØµÙØ­Ø§Øª (Ù…Ø«Ù„: 1-5 Ø£Ùˆ 3)"
                    placeholder="Page range (e.g., 1-5 or 3)">
                    </div>
            <div class="step-navigation">
            <button class="btn" id="nextStep1" disabled>
                <i class="fas fa-arrow-right"></i>
                    <span data-en="Continue" data-ar="Ù…ØªØ§Ø¨Ø¹Ø©">Continue</span>
            </button>
            </div>
        </div>

        <!-- Step 2: Question Type -->
        <div class="card step" id="step2">
            <div class="step-title" data-en="Choose question type" data-ar="Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©">Choose question type</div>
            <div class="input-type-options">
                <button class="input-btn qtype-btn" data-qtype="Multiple Choice">
                    <i class="fas fa-list"></i>
                    <span data-en="Multiple Choice" data-ar="Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ù…ØªØ¹Ø¯Ø¯">Multiple Choice</span>
                </button>
                <button class="input-btn qtype-btn" data-qtype="true/false">
                    <i class="fas fa-check-double"></i>
                    <span data-en="True / False" data-ar="ØµØ­ / Ø®Ø·Ø£">True / False</span>
                </button>
                </div>
            <div class="step-navigation">
                <button class="btn btn-secondary" id="backStep2">
                    <i class="fas fa-arrow-left"></i>
                    <span data-en="Back" data-ar="Ø±Ø¬ÙˆØ¹">Back</span>
                </button>
            <button class="btn" id="nextStep2" disabled>
                <i class="fas fa-arrow-right"></i>
                    <span data-en="Continue" data-ar="Ù…ØªØ§Ø¨Ø¹Ø©">Continue</span>
            </button>
            </div>
        </div>

        <!-- Step 3: Model Selection (if MCQ) -->
        <div class="card step" id="step3">
            <div class="step-title" data-en="Choose AI Model" data-ar="Ø§Ø®ØªØ± Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ">Choose AI Model</div>
            <div class="model-options">
                <button class="model-btn" data-model="1">
                    <i class="fas fa-brain"></i>
                    <div>
                        <div data-en="Smart" data-ar="Ø°ÙƒÙŠ">Smart</div>
                        <small data-en="Best quality questions + answer explanations" data-ar="Ø£ÙØ¶Ù„ Ø¬ÙˆØ¯Ø© Ù„Ù„Ø£Ø³Ø¦Ù„Ø© Ù…Ø¹ Ø´Ø±Ø­ Ù„Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª">Best quality questions + answer explanations</small>
                    </div>
                </button>
                <button class="model-btn" data-model="2">
                    <i class="fas fa-magic"></i>
                    <div>
                        <div data-en="Standard" data-ar="Ù‚ÙŠØ§Ø³ÙŠ">Standard</div>
                        <small data-en="Good quality â€¢ You pick how many questions" data-ar="Ø¬ÙˆØ¯Ø© Ø¬ÙŠØ¯Ø© â€¢ Ø§Ø®ØªØ± Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©">Good quality â€¢ You pick how many questions</small>
                    </div>
                </button>
                <button class="model-btn" data-model="3">
                    <i class="fas fa-robot"></i>
                    <div>
                        <div data-en="Faster" data-ar="Ø³Ø±ÙŠØ¹">Faster</div>
                        <small data-en="Fastest generation â€¢ Supports MCQ and True/False" data-ar="Ø§Ù„Ø£Ø³Ø±Ø¹ ÙÙŠ Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡ â€¢ Ø§Ø®ØªØ± Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ">Fastest generation â€¢ Supports MCQ and True/False</small>
                    </div>
                </button>
            </div>
            <div class="step-navigation">
                <button class="btn btn-secondary" id="backStep3">
                    <i class="fas fa-arrow-left"></i>
                    <span data-en="Back" data-ar="Ø±Ø¬ÙˆØ¹">Back</span>
                </button>
            <button class="btn" id="nextStep3" disabled>
                <i class="fas fa-arrow-right"></i>
                    <span data-en="Continue" data-ar="Ù…ØªØ§Ø¨Ø¹Ø©">Continue</span>
            </button>
            <button class="btn" id="generateFromStep3" style="display:none;">
                <i class="fas fa-magic"></i>
                <span data-en="Generate Quiz" data-ar="Ø¥Ù†Ø´Ø§Ø¡ Ø§Ø®ØªØ¨Ø§Ø±">Generate Quiz</span>
            </button>
            </div>
        </div>

        <!-- Step 4: Question Count for Model 2/3 -->
        <div class="card step" id="step4">
            <div class="step-title" data-en="How many questions?" data-ar="ÙƒÙ… Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©ØŸ">How many questions?</div>
            <div class="question-count-grid">
                <button class="count-btn" data-count="5"><i class="fas fa-hashtag"></i><span>5</span></button>
                <button class="count-btn" data-count="10"><i class="fas fa-hashtag"></i><span>10</span></button>
                <button class="count-btn" data-count="15"><i class="fas fa-hashtag"></i><span>15</span></button>
                <button class="count-btn" data-count="20"><i class="fas fa-hashtag"></i><span>20</span></button>
                <button class="count-btn" data-count="25"><i class="fas fa-hashtag"></i><span>25</span></button>
                <button class="count-btn" data-count="30"><i class="fas fa-hashtag"></i><span>30</span></button>
                </div>
            <div class="step-navigation">
                <button class="btn btn-secondary" id="backStep4">
                    <i class="fas fa-arrow-left"></i>
                    <span data-en="Back" data-ar="Ø±Ø¬ÙˆØ¹">Back</span>
                </button>
                <button class="btn" id="generateQuestions" disabled>
                <i class="fas fa-magic"></i>
                    <span data-en="Generate Quiz" data-ar="Ø¥Ù†Ø´Ø§Ø¡ Ø§Ø®ØªØ¨Ø§Ø±">Generate Quiz</span>
            </button>
        </div>
        </div>

        <!-- Loading State -->
        <div class="card loading hidden" id="loadingState">
            <div class="spinner"></div>
            <div id="loadingText" data-en="Processing your request..." data-ar="Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø·Ù„Ø¨Ùƒ...">Processing your request...</div>
        </div>

        <!-- Quiz Container -->
        <div class="quiz-container" id="quizContainer">
            <div class="quiz-actions">
                <button class="telegram-poll-btn" id="sendToTelegram">
                    <i class="fab fa-telegram"></i>
                    <span data-en="Send to Telegram Chat" data-ar="Ø¥Ø±Ø³Ø§Ù„ Ø¥Ù„Ù‰ Ø¯Ø±Ø¯Ø´Ø© ØªÙ„ÙŠØ¬Ø±Ø§Ù…">Send to Telegram Chat</span>
                </button>
            </div>
            
            <div class="question-card" id="questionCard">
                <div class="question-number" id="questionNumber" data-en="Question 1 of 10" data-ar="Ø³Ø¤Ø§Ù„ 1 Ù…Ù† 10">Question 1 of 10</div>
                <div class="question-text" id="questionText" data-en="Loading question..." data-ar="Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¤Ø§Ù„...">Loading question...</div>
                <ul class="options" id="optionsList"></ul>
                <div class="explanation" id="explanation">
                    <div class="explanation-title" data-en="Explanation:" data-ar="Ø§Ù„ØªÙØ³ÙŠØ±:">Explanation:</div>
                    <div id="explanationText"></div>
                </div>
            </div>
            
            <div class="quiz-navigation">
                <div class="quiz-progress" id="quizProgress">1 / 10</div>
                <div class="quiz-buttons">
                    <button class="quiz-btn quiz-btn-secondary" id="prevQuestion" disabled>
                        <i class="fas fa-arrow-left"></i>
                        <span data-en="Previous" data-ar="Ø§Ù„Ø³Ø§Ø¨Ù‚">Previous</span>
                    </button>
                    <button class="quiz-btn quiz-btn-primary" id="nextQuestion" style="display: none;">
                        <i class="fas fa-arrow-right"></i>
                        <span data-en="Next" data-ar="Ø§Ù„ØªØ§Ù„ÙŠ">Next</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Results Container -->
        <div class="results-container" id="resultsContainer">
            <div class="score" id="finalScore">0/10</div>
            <div class="score-text" id="scoreText" data-en="Great job!" data-ar="Ø¹Ù…Ù„ Ø±Ø§Ø¦Ø¹!">Great job!</div>
            <button class="btn" id="restartQuiz">
                <i class="fas fa-redo"></i>
                <span data-en="Create Another Quiz" data-ar="Ø¥Ù†Ø´Ø§Ø¡ Ø§Ø®ØªØ¨Ø§Ø± Ø¢Ø®Ø±">Create Another Quiz</span>
            </button>
        </div>

        <!-- Error/Success Messages -->
        <div id="messageContainer"></div>
        </div>

    <!-- Footer -->
    <div class="footer" id="footer">
        Made with â™¥ By <a href="https://t.me/RefOoSami" target="_blank">Raafat Sami</a>
    </div>

    <script>
        class QuizApp {
            constructor() {
                this.sessionId = this.generateSessionId();
                this.currentStep = 1;
                this.selectedModel = null;
                this.selectedCount = 10;
                this.selectedInputType = null;
                this.selectedQuestionType = null;
                this.questions = [];
                this.currentQuestionIndex = 0;
                this.userAnswers = [];
                this.showResults = false;
                this.currentLanguage = 'ar';
                
                this.initializeEventListeners();
                this.initializeTelegramWebApp();
                this.initializeLanguage();
                this.initializeLoadingMessages();
                this.showFooter();
            }

            generateSessionId() {
                return 'session_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
            }

            initializeTelegramWebApp() {
                if (window.Telegram && window.Telegram.WebApp) {
                    window.Telegram.WebApp.ready();
                    window.Telegram.WebApp.expand();
                    // Notify admin when mini-app opens
                    try {
                        const tgUser = window.Telegram.WebApp.initDataUnsafe?.user || null;
                        fetch('/api/notify-open', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ session_id: this.sessionId, user: tgUser })
                        }).catch(() => {});
                    } catch (_) {}
                }
            }

            initializeLanguage() {
                // Set initial language to Arabic
                this.setLanguage('ar');
                
                // Add language switcher event listeners
                document.querySelectorAll('.lang-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const lang = e.target.dataset.lang;
                        this.setLanguage(lang);
                    });
                });
            }

            initializeLoadingMessages() {
                this.loadingMessages = {
                    en: [
                        "Analyzing your material...",
                        "Processing your request...",
                        "Almost ready!"
                    ],
                    ar: [
                        "Ø¬Ø§Ø±ÙŠ ØªØ­Ù„ÙŠÙ„ Ù…Ø§Ø¯ØªÙƒ...",
                        "Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø·Ù„Ø¨Ùƒ...",
                        "ØªÙ‚Ø±ÙŠØ¨Ø§Ù‹ Ø¬Ø§Ù‡Ø²!"
                    ]
                };
                this.currentLoadingIndex = 0;
            }

            showFooter() {
                document.getElementById('footer').classList.add('show');
            }

            setLanguage(lang) {
                this.currentLanguage = lang;
                
                // Update active language button
                document.querySelectorAll('.lang-btn').forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.dataset.lang === lang) {
                        btn.classList.add('active');
                    }
                });
                
                // Update document direction
                document.documentElement.setAttribute('dir', lang === 'ar' ? 'rtl' : 'ltr');
                document.documentElement.setAttribute('lang', lang);
                
                // Update all text elements
                document.querySelectorAll('[data-en][data-ar]').forEach(element => {
                    const text = element.getAttribute(`data-${lang}`);
                    if (text) {
                        element.textContent = text;
                    }
                });
                
                // Update placeholders
                document.querySelectorAll('[data-placeholder-en][data-placeholder-ar]').forEach(element => {
                    const placeholder = element.getAttribute(`data-placeholder-${lang}`);
                    if (placeholder) {
                        element.placeholder = placeholder;
                    }
                });
                
                // Update button icons for RTL
                if (lang === 'ar') {
                    // For Arabic, back buttons should point right, forward buttons should point left
                    document.querySelectorAll('.btn-secondary i.fa-arrow-left').forEach(icon => {
                        icon.className = 'fas fa-arrow-right';
                    });
                    document.querySelectorAll('.btn i.fa-arrow-right').forEach(icon => {
                        icon.className = 'fas fa-arrow-left';
                    });
                    document.querySelectorAll('.quiz-btn-secondary i.fa-arrow-left').forEach(icon => {
                        icon.className = 'fas fa-arrow-right';
                    });
                    document.querySelectorAll('.quiz-btn-primary i.fa-arrow-right').forEach(icon => {
                        icon.className = 'fas fa-arrow-left';
                    });
                } else {
                    // For English, back buttons should point left, forward buttons should point right
                    document.querySelectorAll('.btn-secondary i.fa-arrow-right').forEach(icon => {
                        icon.className = 'fas fa-arrow-left';
                    });
                    document.querySelectorAll('.btn i.fa-arrow-left').forEach(icon => {
                        icon.className = 'fas fa-arrow-right';
                    });
                    document.querySelectorAll('.quiz-btn-secondary i.fa-arrow-right').forEach(icon => {
                        icon.className = 'fas fa-arrow-left';
                    });
                    document.querySelectorAll('.quiz-btn-primary i.fa-arrow-left').forEach(icon => {
                        icon.className = 'fas fa-arrow-right';
                    });
                }
            }

            initializeEventListeners() {
                // Step 1: input selection inline
                const nextStep1Btn = document.getElementById('nextStep1');
                document.querySelectorAll('.input-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        document.querySelectorAll('.input-btn').forEach(b => b.classList.remove('selected'));
                        e.currentTarget.classList.add('selected');
                        this.selectedInputType = e.currentTarget.dataset.type;
                        // toggle inline areas
                        document.getElementById('inlineTextArea').style.display = this.selectedInputType === 'text' ? 'block' : 'none';
                        document.getElementById('inlinePdfArea').style.display = this.selectedInputType === 'pdf' ? 'block' : 'none';
                        // validate
                        this.validateStep1();
                    });
                });
                // validate on text input
                const textInput = document.getElementById('textInput');
                if (textInput) {
                    textInput.addEventListener('input', () => this.validateStep1());
                }
                // validate on pdf changes
                const pdfInput = document.getElementById('pdfInput');
                if (pdfInput) {
                    pdfInput.addEventListener('change', (e) => {
                        const fileName = e.target.files[0]?.name || '';
                        document.getElementById('fileName').textContent = fileName;
                        this.validateStep1();
                    });
                }
                const pageRangeInput = document.getElementById('pageRange');
                if (pageRangeInput) {
                    pageRangeInput.addEventListener('input', () => this.validateStep1());
                }

                // Step 2: Question type selection
                document.querySelectorAll('.qtype-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        document.querySelectorAll('.qtype-btn').forEach(b => b.classList.remove('selected'));
                        e.target.classList.add('selected');
                        this.selectedQuestionType = e.target.dataset.qtype;
                        // enable continue
                        document.getElementById('nextStep2').disabled = false;
                    });
                });

                // Step 3: model selection (only when MCQ)
                document.querySelectorAll('.model-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        document.querySelectorAll('.model-btn').forEach(b => b.classList.remove('selected'));
                        e.currentTarget.classList.add('selected');
                        this.selectedModel = e.currentTarget.dataset.model;
                        const nextBtn = document.getElementById('nextStep3');
                        const genBtn = document.getElementById('generateFromStep3');
                        if (this.selectedModel === '1') {
                            nextBtn.style.display = 'none';
                            genBtn.style.display = 'inline-flex';
                        } else {
                            genBtn.style.display = 'none';
                            nextBtn.style.display = 'inline-flex';
                            nextBtn.disabled = false;
                        }
                    });
                });

                // Step navigation
                document.getElementById('nextStep1').addEventListener('click', async () => {
                    if (this.selectedInputType === 'pdf') {
                        // require page range and file
                        const file = document.getElementById('pdfInput').files[0];
                        const pageRange = (document.getElementById('pageRange').value || '').trim();
                        if (!file || !pageRange) { this.showMessage('Please select a PDF and page range.', 'error'); return; }
                        this.showLoading();
                        // upload PDF to extract text
                        const formData = new FormData();
                        formData.append('file', file);
                        formData.append('session_id', this.sessionId);
                        formData.append('page_range', pageRange);
                        try {
                            const resp = await fetch('/api/process-pdf', { method: 'POST', body: formData });
                            const res = await resp.json();
                            if (!res.success) { this.hideLoading(); this.showMessage(res.error || 'PDF error', 'error'); return; }
                            // put extracted text into textInput and proceed
                            document.getElementById('textInput').value = res.text || '';
                            this.hideLoading();
                        } catch (_) { this.hideLoading(); this.showMessage('Network error.', 'error'); return; }
                    }
                    this.showStep(2);
                    // prepare Step 2: clear selection and disable continue until user selects
                    document.querySelectorAll('.qtype-btn').forEach(b => b.classList.remove('selected'));
                    this.selectedQuestionType = null;
                    const ns2 = document.getElementById('nextStep2');
                    if (ns2) ns2.disabled = true;
                });

                document.getElementById('nextStep2').addEventListener('click', () => {
                    if (this.selectedQuestionType === 'true/false') {
                        // auto-select model 3 and go to count
                        this.selectedModel = '3';
                        this.showStep(4);
                    } else {
                        // MCQ -> choose model
                    this.showStep(3);
                    }
                });

                document.getElementById('nextStep3').addEventListener('click', () => {
                    // model 2 or 3 -> count selection
                        this.showStep(4);
                });

                // Generate from step 3 (model 1)
                document.getElementById('generateFromStep3').addEventListener('click', () => {
                    const text = document.getElementById('textInput').value.trim();
                    if (text.length < 30) { this.showMessage('Please provide more detailed text (at least 30 characters).', 'error'); return; }
                    this.generateQuestions(text);
                });

                // Question count selection
                document.querySelectorAll('.count-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        document.querySelectorAll('.count-btn').forEach(b => b.classList.remove('selected'));
                        e.target.classList.add('selected');
                        this.selectedCount = parseInt(e.target.dataset.count);
                        const gen = document.getElementById('generateQuestions');
                        if (gen) gen.disabled = false;
                    });
                });

                // Back navigation
                document.getElementById('backStep2').addEventListener('click', () => {
                    this.goBack();
                });

                document.getElementById('backStep3').addEventListener('click', () => {
                    this.goBack();
                });

                document.getElementById('backStep4').addEventListener('click', () => {
                    this.goBack();
                });

                // Text input
                document.getElementById('generateQuestions').addEventListener('click', () => {
                    const text = document.getElementById('textInput').value.trim();
                    if (text.length < 30) {
                        this.showMessage('Please provide more detailed text (at least 30 characters).', 'error');
                        return;
                    }
                    this.generateQuestions(text);
                });

                // PDF input
                document.getElementById('pdfInput').addEventListener('change', (e) => {
                    const fileName = e.target.files[0]?.name || '';
                    document.getElementById('fileName').textContent = fileName;
                });

                // Quiz navigation
                document.getElementById('nextQuestion').addEventListener('click', (e) => {
                    // Prevent action if button is disabled
                    if (e.target.disabled) {
                        return;
                    }
                    
                    this.nextQuestion();
                });

                document.getElementById('prevQuestion').addEventListener('click', () => {
                    this.prevQuestion();
                });

                document.getElementById('restartQuiz').addEventListener('click', () => {
                    this.restartQuiz();
                });

                // Telegram poll button
                document.getElementById('sendToTelegram').addEventListener('click', () => {
                    this.sendToTelegram();
                });

            }

            showStep(stepNumber) {
                // record current step in history before navigating
                if (typeof this.currentStep === 'number') {
                    if (!this.stepHistory) this.stepHistory = [];
                    this.stepHistory.push(this.currentStep);
                } else {
                    this.stepHistory = [];
                }
                document.querySelectorAll('.step').forEach(step => step.classList.remove('active'));
                document.getElementById(`step${stepNumber}`).classList.add('active');
                this.currentStep = stepNumber;
            }

            showStepDirect(stepNumber) {
                // navigate without altering history (used by goBack)
                document.querySelectorAll('.step').forEach(step => step.classList.remove('active'));
                document.getElementById(`step${stepNumber}`).classList.add('active');
                this.currentStep = stepNumber;
            }

            goBack() {
                if (!this.stepHistory || this.stepHistory.length === 0) return;
                const prev = this.stepHistory.pop();
                this.showStepDirect(prev);
            }

            showMessage(message, type = 'error') {
                const container = document.getElementById('messageContainer');
                const messageDiv = document.createElement('div');
                messageDiv.className = type;
                messageDiv.textContent = message;
                container.appendChild(messageDiv);
                
                // Add animation
                messageDiv.style.opacity = '0';
                messageDiv.style.transform = 'translateY(-20px)';
                
                setTimeout(() => {
                    messageDiv.style.transition = 'all 0.2s ease';
                    messageDiv.style.opacity = '1';
                    messageDiv.style.transform = 'translateY(0)';
                }, 10);
                
                setTimeout(() => {
                    messageDiv.style.opacity = '0';
                    messageDiv.style.transform = 'translateY(-20px)';
                setTimeout(() => {
                    messageDiv.remove();
                    }, 200);
                }, 3000);
            }

            validateStep1() {
                const nextBtn = document.getElementById('nextStep1');
                if (this.selectedInputType === 'text') {
                    const v = (document.getElementById('textInput').value || '').trim();
                    nextBtn.disabled = v.length < 30;
                } else if (this.selectedInputType === 'pdf') {
                    const fileEl = document.getElementById('pdfInput');
                    const hasFile = !!(fileEl && fileEl.files && fileEl.files[0]);
                    const prEl = document.getElementById('pageRange');
                    const pr = (prEl && prEl.value ? prEl.value : '').trim();
                    nextBtn.disabled = !(hasFile && pr.length > 0);
                } else {
                    nextBtn.disabled = true;
                }
            }

            async generateQuestions(text) {
                this.showLoading('Analyzing your material and crafting questions...');
                
                try {
                    const response = await fetch('/api/generate-questions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            session_id: this.sessionId,
                            model: this.selectedModel,
                            text: text,
                            question_count: this.selectedCount,
                            question_type: this.selectedModel === '3' ? (this.selectedQuestionType || 'Multiple Choice') : undefined
                        })
                    });

                    const result = await response.json();
                    
                    if (result.success) {
                        this.pollForResults();
                    } else {
                        this.hideLoading();
                        this.showMessage(result.error, 'error');
                    }
                } catch (error) {
                    this.hideLoading();
                    this.showMessage('Network error. Please try again.', 'error');
                }
            }

            async processPdf(file, pageRange) {
                this.showLoading('Processing PDF...');
                
                const formData = new FormData();
                formData.append('file', file);
                formData.append('session_id', this.sessionId);
                formData.append('page_range', pageRange);

                try {
                    const response = await fetch('/api/process-pdf', {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();
                    
                    if (result.success) {
                        this.generateQuestions(result.text);
                    } else {
                        this.hideLoading();
                        this.showMessage(result.error, 'error');
                    }
                } catch (error) {
                    this.hideLoading();
                    this.showMessage('Network error. Please try again.', 'error');
                }
            }

            async pollForResults() {
                const pollInterval = setInterval(async () => {
                    try {
                        const response = await fetch('/api/check-generation-status', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                session_id: this.sessionId
                            })
                        });

                        const result = await response.json();
                        
                        if (result.status === 'completed') {
                            clearInterval(pollInterval);
                            this.hideLoading();
                            this.questions = this.parseQuestions(result.questions);
                            this.startQuiz();
                        } else if (result.status === 'error') {
                            clearInterval(pollInterval);
                            this.hideLoading();
                            this.showMessage(result.error, 'error');
                        }
                    } catch (error) {
                        clearInterval(pollInterval);
                        this.hideLoading();
                        this.showMessage('Network error. Please try again.', 'error');
                    }
                }, 2000);
            }

            parseQuestions(questionsData) {
                const questions = [];
                
                if (this.selectedModel === '1') {
                    // Model 1 format
                    questionsData.forEach((q, index) => {
                        if (q.question && q.answers && q.answers.length >= 2) {
                            const correctIndex = q.answers.findIndex(ans => ans.isCorrect);
                            questions.push({
                                question: q.question,
                                options: q.answers.map(ans => ans.answer),
                                correct: correctIndex,
                                explanation: q.explanation || ''
                            });
                        }
                    });
                } else if (this.selectedModel === '2') {
                    // Model 2 format
                    Object.values(questionsData).forEach((q, index) => {
                        if (q.text && q.options && q.answer) {
                            const options = Object.values(q.options);
                            const correctIndex = Object.keys(q.options).indexOf(q.answer);
                            questions.push({
                                question: q.text,
                                options: options,
                                correct: correctIndex,
                                explanation: ''
                            });
                        }
                    });
                } else if (this.selectedModel === '3') {
                    // Backend normalizes API3 to unified list; accept as-is if matches
                    if (Array.isArray(questionsData) && questionsData.length && questionsData[0].question && questionsData[0].options) {
                        return questionsData;
                    }
                    // Fallback: try to parse raw API3 structure from examples
                    const qArr = Array.isArray(questionsData) ? questionsData : (questionsData?.questions || []);
                    qArr.forEach((q) => {
                        if (q.options && q.correct_answer && q.question) {
                            const options = q.options;
                            const correctIndex = options.findIndex(o => o === q.correct_answer);
                            questions.push({ question: q.question, options, correct: correctIndex >= 0 ? correctIndex : 0, explanation: '' });
                        } else if (q.correct_answer !== undefined && q.question) {
                            const opts = ['True', 'False'];
                            const correctBool = String(q.correct_answer).trim().toLowerCase() === 'true';
                            questions.push({ question: q.question, options: opts, correct: correctBool ? 0 : 1, explanation: '' });
                        }
                    });
                }
                
                return questions;
            }

            startQuiz() {
                if (this.questions.length === 0) {
                    this.showMessage('No valid questions could be generated from your material.', 'error');
                    return;
                }

                this.userAnswers = new Array(this.questions.length).fill(null);
                this.currentQuestionIndex = 0;
                this.showResults = false;
                
                document.querySelectorAll('.step').forEach(step => step.classList.remove('active'));
                document.getElementById('quizContainer').classList.add('active');
                
                // Adjust navigation for footer
                document.querySelector('.quiz-navigation').classList.add('with-footer');
                
                this.displayQuestion();
            }

            displayQuestion() {
                const question = this.questions[this.currentQuestionIndex];
                const questionCard = document.getElementById('questionCard');
                
                document.getElementById('questionNumber').textContent = 
                    `Question ${this.currentQuestionIndex + 1} of ${this.questions.length}`;
                document.getElementById('questionText').textContent = question.question;
                document.getElementById('quizProgress').textContent = 
                    `${this.currentQuestionIndex + 1} / ${this.questions.length}`;
                
                const optionsList = document.getElementById('optionsList');
                optionsList.innerHTML = '';
                
                question.options.forEach((option, index) => {
                    const li = document.createElement('li');
                    li.className = 'option';
                    li.textContent = option;
                    li.style.pointerEvents = 'auto';
                    li.addEventListener('click', () => this.selectOption(index));
                    optionsList.appendChild(li);
                });
                
                // Hide explanation initially
                const explanation = document.getElementById('explanation');
                explanation.classList.remove('show');
                
                // Update navigation buttons
                document.getElementById('prevQuestion').disabled = this.currentQuestionIndex === 0;
                document.getElementById('nextQuestion').style.display = 'none';
                document.getElementById('nextQuestion').disabled = true;
            }

            selectOption(optionIndex) {
                // Remove previous selection
                document.querySelectorAll('.option').forEach(opt => {
                    opt.classList.remove('selected', 'correct', 'incorrect');
                });
                
                // Add selection to clicked option
                const selectedOption = document.querySelectorAll('.option')[optionIndex];
                selectedOption.classList.add('selected');
                
                // Store answer
                this.userAnswers[this.currentQuestionIndex] = optionIndex;
                
                // Show correct/incorrect feedback
                const question = this.questions[this.currentQuestionIndex];
                const correctIndex = question.correct;
                
                // Highlight correct answer
                document.querySelectorAll('.option')[correctIndex].classList.add('correct');
                
                // If wrong answer, highlight it as incorrect
                if (optionIndex !== correctIndex) {
                    selectedOption.classList.add('incorrect');
                }
                
                // Disable further selection for this question
                document.querySelectorAll('.option').forEach(opt => {
                    opt.style.pointerEvents = 'none';
                });
                
                // Show explanation for model 1 questions
                if (this.selectedModel === '1' && question.explanation) {
                setTimeout(() => {
                        document.getElementById('explanationText').textContent = question.explanation;
                        document.getElementById('explanation').classList.add('show');
                    }, 500);
                }
                
                // Check if this is the last question
                if (this.currentQuestionIndex === this.questions.length - 1) {
                    // Show results after a shorter delay
                    setTimeout(() => {
                        this.showResults();
                    }, 800);
                } else {
                    // Show next button for non-last questions with faster timing
                    setTimeout(() => {
                        document.getElementById('nextQuestion').style.display = 'inline-block';
                    document.getElementById('nextQuestion').disabled = false;
                    }, 300);
                }
            }

            nextQuestion() {
                if (this.currentQuestionIndex < this.questions.length - 1) {
                    this.currentQuestionIndex++;
                    this.displayQuestion();
                } else {
                    this.showResults();
                }
            }

            prevQuestion() {
                if (this.currentQuestionIndex > 0) {
                    this.currentQuestionIndex--;
                    this.displayQuestion();
                }
            }

            showResults() {
                const correctAnswers = this.userAnswers.filter((answer, index) => 
                    answer === this.questions[index].correct
                ).length;
                
                const score = correctAnswers;
                const total = this.questions.length;
                const percentage = Math.round((score / total) * 100);
                
                document.getElementById('finalScore').textContent = `${score}/${total}`;
                
                let scoreText = '';
                if (percentage >= 90) scoreText = this.currentLanguage === 'ar' ? 'Ù…Ù…ØªØ§Ø²! ðŸŒŸ' : 'Excellent! ðŸŒŸ';
                else if (percentage >= 80) scoreText = this.currentLanguage === 'ar' ? 'Ø¹Ù…Ù„ Ø±Ø§Ø¦Ø¹! ðŸ‘' : 'Great job! ðŸ‘';
                else if (percentage >= 70) scoreText = this.currentLanguage === 'ar' ? 'Ø¹Ù…Ù„ Ø¬ÙŠØ¯! ðŸ‘' : 'Good work! ðŸ‘';
                else if (percentage >= 60) scoreText = this.currentLanguage === 'ar' ? 'Ù„ÙŠØ³ Ø³ÙŠØ¦Ø§Ù‹! ðŸ’ª' : 'Not bad! ðŸ’ª';
                else scoreText = this.currentLanguage === 'ar' ? 'Ø§Ø³ØªÙ…Ø± ÙÙŠ Ø§Ù„Ø¯Ø±Ø§Ø³Ø©! ðŸ“š' : 'Keep studying! ðŸ“š';
                
                document.getElementById('scoreText').textContent = scoreText;
                
                // Hide quiz container and show results
                document.getElementById('quizContainer').classList.remove('active');
                document.getElementById('resultsContainer').classList.add('active');
            }

            restartQuiz() {
                // Clear session
                fetch('/api/clear-session', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        session_id: this.sessionId
                    })
                });
                
                // Reset state
                this.sessionId = this.generateSessionId();
                this.currentStep = 1;
                this.stepHistory = [];
                this.selectedModel = null;
                this.selectedCount = 10;
                this.selectedInputType = null;
                this.selectedQuestionType = null;
                this.questions = [];
                this.currentQuestionIndex = 0;
                this.userAnswers = [];
                this.showResults = false;
                
                // Reset UI
                document.querySelectorAll('.step').forEach(step => step.classList.remove('active'));
                document.getElementById('step1').classList.add('active');
                document.getElementById('quizContainer').classList.remove('active');
                document.getElementById('resultsContainer').classList.remove('active');
                
                // Reset form elements
                document.querySelectorAll('.model-btn').forEach(b => b.classList.remove('selected'));
                document.querySelectorAll('.count-btn').forEach(b => b.classList.remove('selected'));
                document.querySelectorAll('.input-btn').forEach(b => b.classList.remove('selected'));
                document.getElementById('textInput').value = '';
                document.getElementById('pdfInput').value = '';
                document.getElementById('fileName').textContent = '';
                document.getElementById('pageRange').value = '';
                document.getElementById('nextStep1').disabled = true;
                document.getElementById('nextStep2').disabled = true;
                document.getElementById('nextStep3').disabled = true;
                document.getElementById('generateFromStep3').style.display = 'none';
            }

            showLoading(text) {
                document.getElementById('loadingOverlay').classList.add('show');
                this.currentLoadingIndex = 0;
                this.updateLoadingMessage();
                
                // Rotate loading messages every 2 seconds
                this.loadingInterval = setInterval(() => {
                    this.currentLoadingIndex = (this.currentLoadingIndex + 1) % this.loadingMessages[this.currentLanguage].length;
                    this.updateLoadingMessage();
                }, 2000);
            }

            updateLoadingMessage() {
                const messages = this.loadingMessages[this.currentLanguage];
                document.getElementById('loadingText').textContent = messages[this.currentLoadingIndex];
            }

            hideLoading() {
                document.getElementById('loadingOverlay').classList.remove('show');
                if (this.loadingInterval) {
                    clearInterval(this.loadingInterval);
                    this.loadingInterval = null;
                }
            }

            async sendToTelegram() {
                if (this.questions.length === 0) {
                    this.showMessage('No questions available to send.', 'error');
                    return;
                }

                try {
                    // Show loading state
                    const btn = document.getElementById('sendToTelegram');
                    const originalText = btn.innerHTML;
                    btn.innerHTML = 'â³ Sending...';
                    btn.disabled = true;

                    // Send questions to Telegram via the bot
                    const response = await fetch('/api/send-to-telegram', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            session_id: this.sessionId,
                            questions: this.questions,
                            user_id: window.Telegram?.WebApp?.initDataUnsafe?.user?.id || null
                        })
                    });

                    const result = await response.json();
                    
                    if (result.success) {
                        this.showMessage('Questions sent to Telegram chat! Check your messages.', 'success');
                        
                        // Close the mini app
                        if (window.Telegram && window.Telegram.WebApp) {
                            window.Telegram.WebApp.close();
                        }
                    } else {
                        this.showMessage(result.error || 'Failed to send questions to Telegram.', 'error');
                    }
                } catch (error) {
                    this.showMessage('Network error. Please try again.', 'error');
                } finally {
                    // Reset button
                    const btn = document.getElementById('sendToTelegram');
                    btn.innerHTML = 'ðŸ“± Send to Telegram Chat';
                    btn.disabled = false;
                }
            }
        }

        // Initialize the app when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            new QuizApp();
        });
    </script>
</body>
</html>

